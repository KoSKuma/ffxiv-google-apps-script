# Google Apps Script Development Rules

## Project Structure
- Use `.gs` extension for Google Apps Script files
- Use `.html` extension for HTML dialog/sidebar files
- Organize code into logical modules (one file per module/feature)
- Keep main entry points in `Code.gs` or `Main.gs`
- Use descriptive file names that reflect their purpose

**Current Module Structure:**
- `Code.gs` - Public API functions (exposed when used as library)
- `Config.gs` - Internal configuration constants
- `Utils.gs` - Internal utility functions for spreadsheet operations
- `FFXIVAPI.gs` - Internal API integration functions
- `Test.gs` - Test functions (kept in production for debugging)
- `LIBRARY_TEMPLATE.gs` - Template code for library users (excluded from push)

**Documentation Structure:**
- `README.md` - Main project readme (root)
- `CHANGELOG.md` - Project changelog (root)
- `docs/` - All documentation files (GETTING_STARTED.md, FEATURE.md, API.md, etc.)
- `releases/` - Detailed release notes (releases/v1.0.0.md, etc.)

## Code Style
- Follow JavaScript ES5/ES6 best practices (Apps Script supports modern JS)
- Use `const` and `let` instead of `var` when possible
- Use arrow functions where appropriate
- Prefer async/await over callbacks for asynchronous operations
- Use JSDoc comments for all functions (especially public API functions)
- Keep functions focused and single-purpose
- Use meaningful variable and function names

## Google Apps Script Specific
- Always handle errors with try-catch blocks
- Use `SpreadsheetApp.getActiveSpreadsheet()` for active spreadsheet operations
- Be mindful of execution time limits (6 minutes for regular scripts)
- Use triggers appropriately (onEdit, onOpen, time-driven, etc.)
- Always request minimal necessary permissions

## Performance
- Cache frequently accessed data (ranges, values, spreadsheet objects) to improve performance
- Use batch operations (getValues/setValues) instead of cell-by-cell operations
- Minimize calls to SpreadsheetApp methods
- Avoid nested loops when working with large datasets
- Consider using Apps Script's built-in array methods (map, filter, reduce)
- Implement rate limiting for external API calls (use `Utilities.sleep()`)

## Error Handling and Logging
- Wrap main functions in try-catch blocks
- Use `logWithTimestamp()` from Utils.gs for timestamped logging (kept in production)
- Provide user-friendly error messages
- Log errors with context for debugging
- Never log sensitive information (API keys, tokens, personal data)

## Security
- Validate all user inputs
- Sanitize data before writing to sheets
- Use appropriate permission scopes
- Never commit sensitive data (API keys, tokens, etc.) to version control
- Use Script Properties for configuration that shouldn't be in code

## Library-Friendly Architecture
- **Public Functions**: High-level functions in `Code.gs` that expose complete functionality
- **Internal Functions**: Functions in `Utils.gs`, `FFXIVAPI.gs`, and `Config.gs` are not exposed
- Library users call: `LibraryName.functionName()` - all internals are handled automatically
- When adding public functions: Add to `Code.gs` with JSDoc comments indicating "PUBLIC API"
- When adding internal functions: Add to appropriate module (`Utils.gs` for spreadsheet ops, `FFXIVAPI.gs` for API calls)

## Testing
- Create test functions for critical logic in `Test.gs`
- Use descriptive test function names with `test` prefix (e.g., `testLookupItemInfo`)
- Test functions are kept in production (not excluded) for debugging
- Test edge cases and error conditions
- Use `onTestOpen()` to create test menu for easy access

## File Exclusion
- Files excluded from `clasp push` (via `.claspignore`):
  - `LIBRARY_TEMPLATE.gs` - Prevents `onOpen()` conflicts
  - Documentation files (`.md` files)
  - Configuration files (`.json`, `.gitignore`, etc.)
- `Test.gs` is included in pushes (not excluded) for production debugging

## Deployment
- Test thoroughly using `Test.gs` functions before deployment
- Update documentation (see Documentation Maintenance section)
- Version your code appropriately
- Document deployment steps in README
- For library deployment: Publish ‚Üí Deploy as library in Apps Script editor

## Communication and Workflow
- **When answering questions**: Always answer the user's question first with a clear explanation
- **After answering**: Ask the user if they would like to update the code or documentation based on the answer
- **Do not assume**: Don't make code changes automatically when answering questions - wait for explicit confirmation
- **Provide context**: When explaining concepts, provide enough detail for understanding before suggesting changes
- **Separate concerns**: Keep explanations separate from implementation suggestions

## Date and Time Handling
- **When dates are needed**: Always check the current date/time using system commands if uncertain
  - Use `date +"%Y-%m-%d"` to get current date in YYYY-MM-DD format
  - Use `date +"%Y"` to get current year
  - Use `date +"%Y-%m-%d %H:%M:%S"` for full date and time
- **Date accuracy**: Never assume or guess dates - always verify the current date when:
  - Adding "Last Updated" dates to features in `docs/FEATURE.md`
  - Adding completion dates to tasks in `docs/TODO.md`
  - Creating new documentation entries with dates
  - Updating version information with dates
- **Date format**: Use ISO 8601 format (YYYY-MM-DD) for all dates in documentation
- **Year accuracy**: Pay special attention to the year - verify it matches the current year

## Documentation Maintenance

### General Principles
- **CRITICAL**: Update markdown documentation files when making significant changes
- Documentation should reflect the current state of the codebase
- Review documentation accuracy during code reviews
- If AI assistants are used, ensure they update relevant documentation files

### When Reviewing/Checking Files
If the user asks to "check", "review", "verify", or "is this up to date" for any file:
- Compare the file content with the actual codebase implementation
- Check for discrepancies between documentation and code
- Verify all examples, function lists, and references are accurate
- Update any outdated information found
- Check related documentation files that might also need updates
- Report what was found and what was updated

### Documentation Files to Update

**When adding new functions:**
- Update `docs/API.md` with function documentation (if public API)
- Update `docs/FEATURE.md` if it's a new feature

**When adding new features:**
- Update `docs/FEATURE.md` with complete feature documentation
- Update `docs/ARCHITECTURE.md` with module information
- Update `docs/API.md` if adding public API functions
- Update `docs/TODO.md` to track progress

**When changing workflows:**
- Update `docs/DEVELOPMENT.md` with new processes

**When modifying code style:**
- Update `docs/CONTRIBUTING.md` and `.cursorrules`

**When adding new patterns:**
- Update `docs/PROMPTS.md` with examples

**General maintenance:**
- Keep `README.md` up to date with project structure and setup instructions

### Feature Documentation (docs/FEATURE.md)
Update `docs/FEATURE.md` when making any changes to features:
- **Adding a new feature**: Add complete documentation using the feature template in `docs/FEATURE.md`
- **Modifying an existing feature**: Update the feature's documentation (parameters, behavior, examples)
- **Removing/deprecating a feature**: Mark as ‚ùå Deprecated and move to appropriate section
- **Changing feature status**: Update status indicator (‚úÖ Implemented, üü° In Progress, üß™ Debug/Utility, ‚¨ú Planned)
- **Required information**: Include function signature, parameters, return values, usage examples, how it works, and any notes

### Task Tracking (docs/TODO.md)
Update `docs/TODO.md` when completing tasks, adding new features, or identifying work items:
- Mark completed tasks as ‚úÖ and move to "Completed Tasks" section
- Add new tasks to appropriate sections (Current Sprint, Planned Features, Technical Debt, etc.)
- Update task status (‚¨ú Not Started, üü° In Progress, ‚úÖ Completed, ‚ùå Cancelled)

### Library Template Maintenance (LIBRARY_TEMPLATE.gs)
Update `LIBRARY_TEMPLATE.gs` when making changes to menu handlers in `Code.gs`:
- When modifying `onOpen()` function: Update the menu structure in `LIBRARY_TEMPLATE.gs`
- When modifying menu handler functions: Update the corresponding functions in `LIBRARY_TEMPLATE.gs`
- Keep the template identical to `Code.gs` menu handlers, but replace direct function calls with library calls (e.g., `lookupItemInfo()` ‚Üí `FFXIVTools.lookupItemInfo()`)
- The template should mirror `Code.gs` menu handlers exactly, only changing function calls to use the library identifier
